L.Control.OpacitySlider=L.Control.extend({includes:L.Evented?L.Evented.prototype:L.Mixin.Events,options:{position:"topright",opacity:100,backgroundColor:"transparent",sliderImageUrl:"opacity-slider3d14.png",margin:5},_OPACITY_MAX_PIXELS:57,initialize:function(layer,options){L.Util.setOptions(this,options);this.overlay=layer},onAdd:function(map){var slider=L.DomUtil.create("DIV","opacity-slider");slider.setAttribute("style","margin:"+this.options.margin+"px;overflow-x:hidden;overflow-y:hidden;background:url("+
this.options.sliderImageUrl+") no-repeat;width:71px;height:21px;cursor:pointer;");var knob=L.DomUtil.create("DIV","knob");knob.setAttribute("style","padding:0;margin:0;overflow-x:hidden;overflow-y:hidden;background:url("+this.options.sliderImageUrl+") no-repeat -71px 0;width:14px;height:21px;");slider.appendChild(knob);this.knob=new this.DraggableObject(knob,{restrictY:true,container:slider,onDragEnd:function(e){var opacity=this.knob.getValueX();this.setOpacity(opacity)}.bind(this)});L.DomEvent.on(slider,
"click",function(e){var left=this.findPosLeft(this._container);var x=e.pageX-left-this.options.margin;this.knob.setValueX(x);this.setOpacity(x)},this);L.DomEvent.disableClickPropagation(slider);this._initialValue=this._OPACITY_MAX_PIXELS/(100/this.options.opacity);this.knob.setValueX(this._initialValue);this.setOpacity(this._initialValue);return slider},setOpacity:function(pixelX){var value=100/this._OPACITY_MAX_PIXELS*pixelX;value=value/100;if(value<0)value=0;this.fire(value>0?"visible":"hidden");
if(this.overlay.eachLayer)this.overlay.eachLayer(function(layer){this._setLayerOpacity(layer,value)},this);else this._setLayerOpacity(this.overlay,value)},_setLayerOpacity:function(layer,value){if(layer.setStyle)layer.setStyle({opacity:value});else if(layer.setOpacity)layer.setOpacity(value)},findPosLeft:function(obj){var curleft=0;if(obj.offsetParent){do{curleft+=obj.offsetLeft;obj=obj.offsetParent}while(obj);return curleft}return undefined},getLayer:function(){return this.layer},setLayer:function(layer){this.layer=
layer},DraggableObject:function(src,options){var self=this;var _opts={draggingCursor:"default",draggableCursor:"default",onDragStart:_dumbFunction,onDragEnd:_dumbFunction,onDragging:_dumbFunction,onMouseDown:_dumbFunction,onMouseUp:_dumbFunction,intervalX:1,intervalY:1,toleranceX:Infinity,toleranceY:Infinity,interval:1};L.Util.extend(_opts,options);var _draggingCursor=_opts.draggingCursor;var _draggableCursor=_opts.draggableCursor;var _dragging=false;var _preventDefault;var _currentX,_currentY,_formerY,
_formerX,_formerMouseX,_formerMouseY;var _top,_left;var _originalX,_originalY;var _target=src.setCapture?src:document;_opts.left=_opts.left||src.offsetLeft;_opts.top=_opts.top||src.offsetTop;src.style.position="absolute";src.addEventListener("mousedown",_mouseDown);_target.addEventListener("mouseup",_mouseUp);_setCursor(false);_moveTo(_opts.left,_opts.top,false);function _setCursor(a){src.style.cursor=a?_draggingCursor:_draggableCursor}function _moveTo(x,y,prevent){_left=Math.round(x);_top=Math.round(y);
if(_opts.intervalX>1){var halfIntervalX=Math.round(_opts.intervalX/2);var roundedIntervalX=Math.round(_left%_opts.intervalX);_left=roundedIntervalX<halfIntervalX?_left-roundedIntervalX:_left+(_opts.intervalX-roundedIntervalX)}if(_opts.intervalY>1){var halfIntervalY=Math.round(_opts.intervalY/2);var roundedIntervalY=Math.round(_top%_opts.intervalY);_top=roundedIntervalY<halfIntervalY?_top-roundedIntervalY:_top+(_opts.intervalY-roundedIntervalY)}if(_opts.container&&_opts.container.offsetWidth){_left=
Math.max(0,Math.min(_left,_opts.container.offsetWidth-src.offsetWidth));_top=Math.max(0,Math.min(_top,_opts.container.offsetHeight-src.offsetHeight))}if(typeof _currentX==="number")if(_left-_currentX>_opts.toleranceX||_currentX-(_left+src.offsetWidth)>_opts.toleranceX||(_top-_currentY>_opts.toleranceY||_currentY-(_top+src.offsetHeight)>_opts.toleranceY)){_left=_originalX;_top=_originalY}src.style.left=!_opts.restrictX&&!prevent?_left+"px":src.style.left;src.style.top=!_opts.restrictY&&!prevent?_top+
"px":src.style.top}function _mouseMove(ev){var e=ev||event;_currentX=_formerX+(_getFormerMouseX(e)-_formerMouseX);_currentY=_formerY+(_getFormerMouseY(e)-_formerMouseY);_formerX=_currentX;_formerY=_currentY;_formerMouseX=_getFormerMouseX(e);_formerMouseY=_getFormerMouseY(e);if(_dragging){_moveTo(_currentX,_currentY,_preventDefault);_opts.onDragging({mouseX:_formerMouseX,mouseY:_formerMouseY,startLeft:_originalX,startTop:_originalY,event:e})}}function _mouseDown(ev){var e=ev||event;_setCursor(true);
_opts.onMouseDown(e);if(src.style.position!=="absolute"){src.style.position="absolute";return}_formerMouseX=_getFormerMouseX(e);_formerMouseY=_getFormerMouseY(e);_originalX=src.offsetLeft;_originalY=src.offsetTop;_formerX=_originalX;_formerY=_originalY;_target.addEventListener("mousemove",_mouseMove);if(src.setCapture)src.setCapture();if(e.preventDefault){e.preventDefault();e.stopPropagation()}else{e.cancelBubble=true;e.returnValue=false}_dragging=true;_opts.onDragStart({mouseX:_formerMouseX,mouseY:_formerMouseY,
startLeft:_originalX,startTop:_originalY,event:e})}function _mouseUp(ev){var e=ev||event;if(_dragging){_setCursor(false);_target.removeEventListener("mousemove",_mouseMove);if(src.releaseCapture)src.releaseCapture();_dragging=false;_opts.onDragEnd({mouseX:_formerMouseX,mouseY:_formerMouseY,startLeft:_originalX,startTop:_originalY,event:e})}_currentX=_currentY=null;_opts.onMouseUp(e)}function _getFormerMouseX(e){return e.pageX||e.clientX+document.body.scrollLeft+document.documentElement.scrollLeft}
function _getFormerMouseY(e){return e.pageY||e.clientY+document.body.scrollTop+document.documentElement.scrollTop}function _dumbFunction(e){}self.moveTo=function(point){_moveTo(point.x,point.y,false)};self.moveBy=function(size){_moveTo(src.offsetLeft+size.width,src.offsetHeight+size.height,false)};self.setDraggingCursor=function(cursor){_draggingCursor=cursor;_setCursor(_dragging)};self.setDraggableCursor=function(cursor){_draggableCursor=cursor;_setCursor(_dragging)};self.left=function(){return _left};
self.top=function(){return _top};self.getValueX=function(){var i=_opts.intervalX||1;return Math.round(_left/i)};self.getValueY=function(){var i=_opts.intervalY||1;return Math.round(_top/i)};self.setValueX=function(value){_moveTo(value*_opts.intervalX,_top,false)};self.setValueY=function(value){_moveTo(_left,value*_opts.intervalY,false)};self.preventDefaultMovement=function(prevent){_preventDefault=prevent}}});
